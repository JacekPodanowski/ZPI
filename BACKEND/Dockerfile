# --- ETAP 1: "Builder" ---
FROM python:3.13-slim-bookworm AS builder

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

RUN apt-get update && apt-get install -y --no-install-recommends gcc libpq-dev && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY requirements.txt .
RUN pip wheel --no-cache-dir --wheel-dir /wheels -r requirements.txt


# --- ETAP 2: "Final" ---
FROM python:3.13-slim-bookworm AS final

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# KROK 1: Jako `root`, instalujemy zale≈ºno≈õci systemowe, w tym dos2unix
RUN apt-get update && apt-get install -y libpq5 dos2unix && rm -rf /var/lib/apt/lists/*

# KROK 2: Tworzymy u≈ºytkownika nie-root i katalog domowy
RUN useradd --create-home --shell /bin/bash appuser

# KROK 3: Ustawiamy zmiennƒÖ PATH, aby wskazywa≈Ça na katalog,
# gdzie pip instaluje programy takie jak gunicorn.
ENV PATH="/home/appuser/.local/bin:${PATH}"

# KROK 4: Kopiujemy "skompilowane" pakiety z etapu "builder" i instalujemy je
# Nadal jako `root`, ale instalujemy je w katalogu domowym przysz≈Çego u≈ºytkownika.
WORKDIR /home/appuser/app
COPY --from=builder /wheels /wheels
RUN pip install --no-cache-dir /wheels/*

# KROK 5: Kopiujemy resztƒô plik√≥w aplikacji i ZMIENIAMY ICH W≈ÅA≈öCICIELA na `appuser`
COPY --chown=appuser:appuser . .

# üÜï KROK 5.5: Generujemy migracje podczas budowania obrazu (opcjonalne)
# Uwaga: To zadzia≈Ça tylko je≈õli masz ju≈º pliki modeli w projekcie
# Je≈õli wolisz generowaƒá migracje w entrypoint.sh, zakomentuj te linie
# RUN python manage.py makemigrations --noinput || true

# KROK 5.6: Naprawiamy zako≈Ñczenia linii w skrypcie entrypoint
# U≈ºywamy dos2unix, aby zapewniƒá, ≈ºe skrypt ma zako≈Ñczenia linii w formacie Unix (LF)
# i nadajemy mu uprawnienia do wykonywania.
RUN dos2unix entrypoint.sh && chmod +x entrypoint.sh

# KROK 6: Dopiero teraz, gdy wszystko jest gotowe, prze≈ÇƒÖczamy siƒô na u≈ºytkownika nie-root
USER appuser

# Informujemy Dockera, na kt√≥rym porcie bƒôdzie dzia≈Çaƒá serwer Gunicorn
EXPOSE 8000

# Definiujemy skrypt startowy (jest ju≈º w WORKDIR i ma nadane uprawnienia)
ENTRYPOINT ["sh", "./entrypoint.sh"]

# Domy≈õlna komenda, kt√≥ra zostanie przekazana do entrypoint.sh.
CMD ["gunicorn", "--workers", "3", "--bind", "0.0.0.0:8000", "site_project.wsgi:application"]